#!/usr/bin/env cached-nix-shell
#! nix-shell -p ruby_3_1 rubyPackages_3_1.json -i "ruby -S"

require_relative '../lib/rofi'

main do
  # puts _process_args [ 'hello', 'world' ]
  # exit

  if ARGV.length == 1 && ARGV[0] != '-u'
    raise UserError, "Unknown argument(s): #{ARGV.join(' ')}"
  end
  command = ARGV[0] == '-u' ? 'unmount' : 'mount'

  Rofi.theme = "mountmenu.rasi"
  devices = JSON.parse(`lsblk --json -po "tran,name,type,size,mountpoint,label,vendor,model,fstype"`)["blockdevices"]
              .filter { |v| v['tran'] == 'usb' && !v['children'].empty? }
              .map { |v| v['children'] }.flatten(1)
              .filter { |v| v['type'] == 'part' }
              .filter { |v| !!v['mountpoint'] == (command == 'unmount') }

  raise UserError, "No devices available to #{command}." if devices.empty?
  result = Rofi.list(devices, prompt: "#{command.capitalize} device") do |d|
    sprintf("%-42s  %-8s %-14s%s",
            d['mountpoint'] ?
              sprintf("%s -> %s", d['name'], d['mountpoint']).truncate(42) :
              d['name'],
            d['size'],
            d['fstype'],
            (" <span alpha=\"50%\">#{d['label']}</span>" if d['label']))
  end
  puts result.to_struct if result

  # TODO
end
